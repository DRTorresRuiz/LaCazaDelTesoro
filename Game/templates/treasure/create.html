<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<style>
      #map {
          height: 600px;
          width: 600px;
          margin: 10px;
      }
</style>
</head>
<body>
<table>
    <tr>
        <td style="vertical-align: top">
            <div id="map"><p>Click on the map to add marker.</p></div>
        </td>
        <td>
         {% load widget_tweaks %}
        {% block content %}
              <h2>Treasure</h2>
              <form method="POST" class="post-form" enctype="multipart/form-data" novalidate>{% csrf_token %}
                <!-- {{ form.as_p }}-->
                  {% for hidden_field in form.hidden_fields %}
                  {{ hidden_field }}
                  {% endfor %}

                  {% if form.non_field_errors %}
                  <div class="alert alert-danger" role="alert">
                    {% for error in form.non_field_errors %}
                      {{ error }}
                    {% endfor %}
                  </div>
                  {% endif %}
                  {% for field in form.visible_fields %}
                  <div class="form-group">
                  {{ field.label_tag }}

                {% if form.is_bound %}
                  {% if field.errors %}
                    {% render_field field class="form-control is-invalid" %}
                    {% for error in field.errors %}
                      <div class="invalid-feedback">
                        {{ error }}
                      </div>
                    {% endfor %}
                  {% else %}
                    {% render_field field class="form-control is-valid" %}
                  {% endif %}
                {% else %}
                  {% render_field field class="form-control" %}
                {% endif %}

                {% if field.help_text %}
                  <small class="form-text text-muted">{{ field.help_text }}</small>
                {% endif %}
              </div>
            {% endfor %}
                  <button type="submit" class="save btn btn-default">Save</button>
               </form>
        {% endblock %}
        </td>
        <td style="vertical-align: super;">
            <h2>Treasures list</h2>
            <table cellpadding="10">
              <tr>
                  <th>Name</th>
                  <th>Clue</th>
                  <th>Solution</th>
                  <th>Position</th>
              </tr>
            {% for treasure in treasure_list %}
              <tr>
                  <td>
                    {{ treasure.name }}
                  </td>
                  <td>
                    {{ treasure.clue }}
                  </td>
                  <td>
                    {{ treasure.solution }}
                  </td>
                  <td>
                    {{ treasure.position }}
                  </td>
              </tr>
            {% endfor %}
          </table>
            <a href="{% url 'treasure_list' game_id=game_id %}"><button type="button" class="save btn btn-default">Finish</button></a>
        </td>
    </tr>
</table>
<script>
      // In the following example, markers appear when the user clicks on the map.
      // The markers are stored in an array.
      // The user can then click an option to hide, show or delete the markers.
      var map;
      var markers = [];
      var geocoder;
      var infowindow;
      function initMap() {
            var default_position = { lat: 36.7090448, lng: -4.4696866 };
            geocoder = new google.maps.Geocoder;
            infowindow = new google.maps.InfoWindow;

            map = new google.maps.Map(document.getElementById('map'), {
              zoom: 15,
              center: default_position,
              mapTypeId: 'terrain'
            });

            // This event listener will call addMarker() when the map is clicked.
            map.addListener('click', function(event) {
              deleteMarkers();
              addMarker(event.latLng);
            });

            // Adds a marker at the center of the map.
            //addMarker(default_position);
          }

          // Adds a marker to the map and push to the array.
          function addMarker(location) {
            var marker = new google.maps.Marker({
              position: location,
              map: map
            });
            markers.push(marker);
            //alert(marker.getPosition());
              var positionxy = marker.getPosition();
              /*Comentado hasta que se quite la restriccion en google apo
                geocodeLatLng(geocoder, map, infowindow, positionxy);
               */
              var positionxy_str = positionxy.toString().slice(1,-1);
              var latlngStr = positionxy_str.split(',', 2);
              document.getElementById("id_position_0").value = latlngStr[0];
              document.getElementById("id_position_1").value = latlngStr[1];
              document.getElementById("id_address").value = 'NA';
          }

          // Sets the map on all markers in the array.
          function setMapOnAll(map) {
            for (var i = 0; i < markers.length; i++) {
              markers[i].setMap(map);
            }
          }

          // Removes the markers from the map, but keeps them in the array.
          function clearMarkers() {
            setMapOnAll(null);
          }

          // Shows any markers currently in the array.
          function showMarkers() {
            setMapOnAll(map);
          }

          // Deletes all markers in the array by removing references to them.
          function deleteMarkers() {
            clearMarkers();
            markers = [];
          }

          function geocodeLatLng(geocoder, map, infowindow, inputvalue) {
              geocoder.geocode({'location': inputvalue}, function(results, status) {
                if (status === 'OK') {
                  if (results[0]) {
                    document.getElementById("id_address").value = results[0].formatted_address;
                    infowindow.setContent(results[0].formatted_address);
                    infowindow.open(map, marker);
                  } else {
                    document.getElementById("id_address").value = 'NA';
                  }
                } else {
                  document.getElementById("id_address").value = 'NA';
                }
              });
          }
</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?address=Placename&key=AIzaSyAHCaVnPMaUAjAtjpINPxhmHfsr5876u6k&callback=initMap">
</script>
</body>