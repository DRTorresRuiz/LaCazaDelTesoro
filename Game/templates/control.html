<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<style>
      #map {
          height: 600px;
          width: 600px;
          margin: 10px;
      }
</style>
</head>
<body>
<table>
    <tr>
        <td style="vertical-align: top">
            <div id="map"><p>Click on the map to add marker.</p></div>
        </td>
        <td style="vertical-align: top;">
         {% load widget_tweaks %}
        {% block content %}
            <h2 style="display: inline-block;">{{game}}</h2>&nbsp;
            <h3 style="display: inline-block;">
                {%if game.status == 2%}
                    <span class="badge badge-success">Active</span>
                {% else %}
                    <span class="badge badge-danger">Finished</span>
                {% endif %}
            </h3>
            {% if user.is_superuser %}
                <h6>Creator: {{game.creator}}</h6>
            {% endif %}
            {% if game.status == 1 %}
                <h6>Winner: {{game.winner}}</h6>
            {% endif %}
            <div class="accordion" id="accordionExample">
              {% for treasure_found in treasure_list %}
                <div class="card">
                    <div class="card-header" id="heading{{ forloop.counter }}">
                      <h2 class="mb-0">
                        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapse{{ forloop.counter }}" aria-expanded="true" aria-controls="collapse{{ forloop.counter }}">
                          {{treasure_found.name}}&nbsp;&nbsp;<span class="badge badge-primary badge-pill">{{treasure_found.treasure.count}} players</span>
                        </button>
                      </h2>
                    </div>

                    <div id="collapse{{ forloop.counter }}" class="collapse" aria-labelledby="heading{{ forloop.counter }}" data-parent="#accordionExample">
                  <div class="card-body">
                      <ul class="list-group">
                          <b>Payers</b>
                          {% for found in treasure_found.treasure.all %}
                            <li class="list-group-item">{{found.player}}</li>
                          {% endfor %}
                      </ul>
                  </div>
                </div>
                </div>
              {% endfor %}
            </div>
            {% if not user.is_superuser %}
                <button type="button" id="rstBtn" class="btn btn-danger" style="margin-top:10px;" onclick="resetGame({{game.id}})">Reset game</button>
            {% endif %}
                <a href="/"><button type="button" class="save btn btn-warning" style="margin-top:10px;">Go Home</button></a>
        {% endblock %}
        </td>
    </tr>
</table>
<script>
      // In the following example, markers appear when the user clicks on the map.
      // The markers are stored in an array.
      // The user can then click an option to hide, show or delete the markers.
      var map;
      var markers = [];
      var infowindow;
      function initMap() {
            var center = {{center_game}};
            var default_position = { lat: center[0], lng: center[1] };
            infowindow = new google.maps.InfoWindow;

            map = new google.maps.Map(document.getElementById('map'), {
              zoom: 15,
              center: default_position,
              mapTypeId: 'terrain'
            });

            setRectangle(new google.maps.LatLng({{coord_ne}}), new google.maps.LatLng({{coord_sw}}));
            addTreasureMarkers({{treasure_points |safe}});
          }

          // Adds a marker to the map and push to the array.
          function addTreasureMarkers(locations_list) {
            for (const location_p of locations_list) {
                var marker = new google.maps.Marker({
                  position: { lat: location_p[0], lng: location_p[1] },
                  map: map,
                  icon: {
                      url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                   },
                   title: location_p[2]
                });
            }
          }

          // Sets the map on all markers in the array.
          function setMapOnAll(map) {
            for (var i = 0; i < markers.length; i++) {
              markers[i].setMap(map);
            }
          }

          // Removes the markers from the map, but keeps them in the array.
          function clearMarkers() {
            setMapOnAll(null);
          }

          // Shows any markers currently in the array.
          function showMarkers() {
            setMapOnAll(map);
          }

          // Deletes all markers in the array by removing references to them.
          function deleteMarkers() {
            clearMarkers();
            markers = [];
          }

          // create rectangle
          function setRectangle(coord_ne, coord_sw) {
              var bounds = new google.maps.LatLngBounds();
              bounds.extend(coord_ne);
              bounds.extend(coord_sw);

               // Define the rectangle and set its editable property to true.
               rectangle = new google.maps.Rectangle({
                 bounds: bounds,
                 editable: false,
                 draggable: false,
                 fillColor: '#FCEBA2',
                 fillOpacity: 0.2
               });

               rectangle.setMap(map);
           }

           function resetGame(gameId) {
              var txt;
              var r = confirm("Are you sure?");
              if (r == true) {
                // loader
                var text = '<i class="fa fa-circle-o-notch fa-spin"></i> loading...';
                $("#rstBtn").html(text);

               $.ajax({
                    url: '/Game/reset/'+gameId,
                    success: function (data) {
                      location.reload();
                    }
                  });
              }
            }

</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?address=Placename&key=AIzaSyAHCaVnPMaUAjAtjpINPxhmHfsr5876u6k&callback=initMap">
</script>
</body>